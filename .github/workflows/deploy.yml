name: Azure Static Website Deployment

on:
  push:
    branches:
      - main
    paths:
      - "website/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch: # Allow manual trigger

env:
  RESOURCE_GROUP: static-website-rg
  VM_NAME: website-vm
  ADMIN_USERNAME: azureuser

jobs:
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get VM Public IP
        id: get-ip
        run: |
          PUBLIC_IP=$(az network public-ip show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name website-public-ip \
            --query ipAddress \
            --output tsv)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "‚úÖ VM Public IP: $PUBLIC_IP"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get-ip.outputs.public_ip }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ${{ env.ADMIN_USERNAME }}@${{ steps.get-ip.outputs.public_ip }} \
            "echo 'SSH connection successful'"

      - name: Deploy Website Files
        run: |
          echo "üì§ Uploading website files..."

          # Create temporary directory on remote server
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ env.ADMIN_USERNAME }}@${{ steps.get-ip.outputs.public_ip }} \
            "mkdir -p /tmp/website-deploy && rm -rf /tmp/website-deploy/*"

          # Upload files
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r website/* \
            ${{ env.ADMIN_USERNAME }}@${{ steps.get-ip.outputs.public_ip }}:/tmp/website-deploy/

          echo "üîß Installing files and restarting NGINX..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ env.ADMIN_USERNAME }}@${{ steps.get-ip.outputs.public_ip }} << 'ENDSSH'
            set -e
            
            # Backup current site
            sudo cp -r /var/www/html /var/www/html.backup 2>/dev/null || true
            
            # Deploy new files
            sudo rm -rf /var/www/html/*
            sudo cp -r /tmp/website-deploy/* /var/www/html/
            
            # Set correct permissions
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html
            sudo find /var/www/html -type f -exec chmod 644 {} \;
            
            # Restart NGINX
            sudo systemctl restart nginx
            
            # Verify NGINX is running
            sudo systemctl is-active nginx
            
            # Clean up
            rm -rf /tmp/website-deploy
            
            echo "‚úÖ Website deployed successfully!"
          ENDSSH

      - name: Verify Deployment
        run: |
          echo "üîç Verifying website is accessible..."
          sleep 5

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            http://${{ steps.get-ip.outputs.public_ip }} || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Website is accessible! HTTP Status: $HTTP_CODE"
            echo "üåê URL: http://${{ steps.get-ip.outputs.public_ip }}"
          else
            echo "‚ö†Ô∏è Website returned HTTP Status: $HTTP_CODE"
            echo "This might be temporary. Check the website manually."
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          if [ "${{ job.status }}" = "success" ]; then
            echo "üéâ Deployment Status: SUCCESS"
            echo "üåê Website URL: http://${{ steps.get-ip.outputs.public_ip }}"
          else
            echo "‚ùå Deployment Status: FAILED"
            echo "Check the logs above for details"
          fi
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  test:
    name: Run Tests
    needs: deploy
    runs-on: ubuntu-latest
    if: success() # Only run if deploy succeeded

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get VM Public IP
        id: get-ip
        run: |
          PUBLIC_IP=$(az network public-ip show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name website-public-ip \
            --query ipAddress \
            --output tsv)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Test Website Response
        run: |
          echo "üß™ Running website tests..."

          # Test HTTP response
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            http://${{ steps.get-ip.outputs.public_ip }} || echo "000")
          echo "HTTP Status Code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå HTTP test failed"
            exit 1
          fi

          # Test response time
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' \
            http://${{ steps.get-ip.outputs.public_ip }})
          echo "Response Time: ${RESPONSE_TIME}s"

          # Check if content is HTML
          CONTENT=$(curl -s http://${{ steps.get-ip.outputs.public_ip }})
          if echo "$CONTENT" | grep -qi "<!DOCTYPE html"; then
            echo "‚úÖ HTML content verification passed"
          else
            echo "‚ö†Ô∏è Content might not be HTML"
          fi

          # Check for common elements
          if echo "$CONTENT" | grep -qi "<title>"; then
            echo "‚úÖ Title tag found"
          fi

          if echo "$CONTENT" | grep -qi "<body>"; then
            echo "‚úÖ Body tag found"
          fi

          echo "‚úÖ All tests passed!"
